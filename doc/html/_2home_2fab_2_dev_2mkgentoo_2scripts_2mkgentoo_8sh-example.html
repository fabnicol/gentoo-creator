<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>mkgentoo: /home/fab/Dev/mkgentoo/scripts/mkgentoo.sh</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="gentoo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">mkgentoo
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Gentoo distribution creator</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/fab/Dev/mkgentoo/scripts/mkgentoo.sh</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line">mkgentoo language=fr minimal=<span class="keyword">true</span> debug_mode=<span class="keyword">true</span> ncpus=8 nonroot_user=ken passwd=<span class="stringliteral">&#39;util!Hx&amp;32F&#39;</span> rootpasswd=<span class="stringliteral">&#39;Hk_32!_CD&#39;</span> cleanup=<span class="keyword">false</span></div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="preprocessor">##</span></div>
<div class="line"><span class="preprocessor"># Copyright (c) 2020 Fabrice Nicol &lt;fabrnicol@gmail.com&gt;</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># This file is part of mkgentoo.</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># mkgentoo is free software; you can redistribute it and/or</span></div>
<div class="line"><span class="preprocessor"># modify it under the terms of the GNU Lesser General Public</span></div>
<div class="line"><span class="preprocessor"># License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="preprocessor"># version 3 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># FFmpeg is distributed in the hope that it will be useful,</span></div>
<div class="line"><span class="preprocessor"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><span class="preprocessor"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span></div>
<div class="line"><span class="preprocessor"># Lesser General Public License for more details.</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># You should have received a copy of the GNU Lesser General Public</span></div>
<div class="line"><span class="preprocessor"># License along with FFmpeg; if not, write to the Free Software</span></div>
<div class="line"><span class="preprocessor"># Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301</span></div>
<div class="line"><span class="preprocessor">##</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#!/bin/bash</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">## @file mkgentoo.sh</span></div>
<div class="line"><span class="preprocessor">## @author Fabrice Nicol &lt;fabrnicol@gmail.com&gt;</span></div>
<div class="line"><span class="preprocessor">## @copyright GPL v.3</span></div>
<div class="line"><span class="preprocessor">## @brief Process options, create Gentoo VirtualBox machine and optionally create clonezilla install medium</span></div>
<div class="line"><span class="preprocessor">## @note This file is not included into the clonezilla ISO liveCD.</span></div>
<div class="line"><span class="preprocessor">## @defgroup createInstaller Create Gentoo linux image and installer.</span></div>
<div class="line"><span class="preprocessor">## @par USAGE</span></div>
<div class="line"><span class="preprocessor">## @code</span></div>
<div class="line"><span class="preprocessor">## mkgentoo  [[switch=argument]...]  filename.iso  [1]</span></div>
<div class="line"><span class="preprocessor">## mkgentoo  [[switch=argument]...]                [2]</span></div>
<div class="line"><span class="preprocessor">## mkgentoo  help[=md]                             [3]</span></div>
<div class="line"><span class="preprocessor">## @endcode</span></div>
<div class="line"><span class="preprocessor">## @par</span></div>
<div class="line"><span class="preprocessor">## Usage [1] creates a bootable ISO output file with a current Gentoo distribution.   @n</span></div>
<div class="line"><span class="preprocessor">## Usage [2] creates a VirtualBox VDI dynamic disk and a virtual machine with name Gentoo.   @n</span></div>
<div class="line"><span class="preprocessor">## Usage [3] prints this help, in markdown form if argument &#39;md&#39; is specified.  @n</span></div>
<div class="line"><span class="preprocessor">## @par</span></div>
<div class="line"><span class="preprocessor">## Run: @code mkgentoo help @endcode to print a list of possible switches and arguments.</span></div>
<div class="line"><span class="preprocessor">##</span></div>
<div class="line"><span class="preprocessor">## @warning you should have at least 55 GB of free disk space in the current directory or in vmpath if specified.</span></div>
<div class="line"><span class="preprocessor">## Boolean values are either &#39;true&#39; or &#39;false&#39;. For example, to build a minimal distribution,</span></div>
<div class="line"><span class="preprocessor">## specify &lt;tt&gt; minimal=true&lt;/tt&gt; on command line.</span></div>
<div class="line"><span class="preprocessor">##</span></div>
<div class="line"><span class="preprocessor">## @example</span></div>
<div class="line"><span class="preprocessor">## @code</span></div>
<div class="line"><span class="preprocessor">## mkgentoo language=fr minimal=true debug_mode=true ncpus=8 nonroot_user=ken passwd=&#39;util!Hx&amp;32F&#39; rootpasswd=&#39;Hk_32!_CD&#39; cleanup=false</span></div>
<div class="line"><span class="preprocessor">## @endcode</span></div>
<div class="line"> </div>
<div class="line">cd ..</div>
<div class="line"> </div>
<div class="line">CLI=<span class="stringliteral">&quot;$*&quot;</span></div>
<div class="line"> </div>
<div class="line">declare -a <a name="a0"></a><a class="code" href="mkgentoo_8sh.html#a214cb10953cb8efbb6a2092fdb4ff6fd">ARR</a></div>
<div class="line"> </div>
<div class="line"><a class="code" href="mkgentoo_8sh.html#a214cb10953cb8efbb6a2092fdb4ff6fd">ARR</a>=(<span class="stringliteral">&quot;minimal&quot;</span>     <span class="stringliteral">&quot;Remove *libreoffice* and *data science tools* from default list of installed software&quot;</span>  <span class="stringliteral">&quot;false&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;elist&quot;</span>       <span class="stringliteral">&quot;\t File containing a list of Gentoo ebuilds to add to the VM on top of stage3&quot;</span> <span class="stringliteral">&quot;ebuilds.list&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;vm&quot;</span>          <span class="stringliteral">&quot;\t Virtual Machine name&quot;</span>                                             <span class="stringliteral">&quot;Gentoo&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;vbpath&quot;</span>      <span class="stringliteral">&quot;Path to VirtualBox directory&quot;</span>                                        <span class="stringliteral">&quot;/usr/bin&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;vmpath&quot;</span>      <span class="stringliteral">&quot;Path to VM base directory&quot;</span>                                           <span class="stringliteral">&quot;$PWD&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;mem&quot;</span>         <span class="stringliteral">&quot;\t VM RAM memory in MiB&quot;</span>                                             <span class="stringliteral">&quot;8000&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;ncpus&quot;</span>       <span class="stringliteral">&quot;\t Number of VM CPUs. By default the third of available threads.&quot;</span>    <span class="stringliteral">&quot;$(($(nproc --all)/3))&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;processor&quot;</span>   <span class="stringliteral">&quot;Processor type&quot;</span>                                                      <span class="stringliteral">&quot;amd64&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;size&quot;</span>        <span class="stringliteral">&quot;\t Dynamic disc size&quot;</span>                                                <span class="stringliteral">&quot;55000&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;livecd&quot;</span>      <span class="stringliteral">&quot;Path to the live CD that will start the VM&quot;</span>                          <span class="stringliteral">&quot;gentoo.iso&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;mirror&quot;</span>      <span class="stringliteral">&quot;Mirror site for downloading of stage3 tarball&quot;</span>                       <span class="stringliteral">&quot;http://gentoo.mirrors.ovh.net/gentoo-distfiles/&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;emirrors&quot;</span>    <span class="stringliteral">&quot;Mirror sites for downloading ebuilds&quot;</span>                                <span class="stringliteral">&quot;http://gentoo.mirrors.ovh.net/gentoo-distfiles/&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;rstudio&quot;</span>     <span class="stringliteral">&quot;RStudio version to be downloaded and built from github source&quot;</span>       <span class="stringliteral">&quot;1.3.1073&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;r_version&quot;</span>   <span class="stringliteral">&quot;R version&quot;</span>                                                           <span class="stringliteral">&quot;4.0.2&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;githubpath&quot;</span>  <span class="stringliteral">&quot;RStudio Github path to zip: path right before version.zip&quot;</span>           <span class="stringliteral">&quot;https://github.com/rstudio/rstudio/archive/v&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;cflags&quot;</span>      <span class="stringliteral">&quot;GCC CFLAGS options for ebuilds&quot;</span>                                      <span class="stringliteral">&quot;-march=core-avx2 -O2&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;nonroot_user&quot;</span> <span class="stringliteral">&quot;Non-root user&quot;</span>                                                      <span class="stringliteral">&quot;fab&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;passwd&quot;</span>      <span class="stringliteral">&quot;User password&quot;</span>                                                       <span class="stringliteral">&quot;dev20&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;rootpasswd&quot;</span>  <span class="stringliteral">&quot;Root password&quot;</span>                                                       <span class="stringliteral">&quot;dev20&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;download&quot;</span>    <span class="stringliteral">&quot;Download install ISO image from Gentoo mirror&quot;</span>                       <span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;download_stage3&quot;</span> <span class="stringliteral">&quot;Download and install stage3 tarball to virtual disk&quot;</span>             <span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;download_rstudio&quot;</span>  <span class="stringliteral">&quot;Download and build RStudio&quot;</span>                                    <span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;download_clonezilla&quot;</span> <span class="stringliteral">&quot;Refresh CloneZilla ISO download&quot;</span>                             <span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;download_clonezilla_path&quot;</span> <span class="stringliteral">&quot;Use the following CloneZilla ISO&quot;</span>                       <span class="stringliteral">&quot;https://sourceforge.net/projects/clonezilla/files/clonezilla_live_alternative/20200703-focal/clonezilla-live-20200703-focal-amd64.iso/download&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;build_virtualbox&quot;</span>   <span class="stringliteral">&quot;Download code source and automatically build virtualbox and tools&quot;</span> <span class="stringliteral">&quot;false&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;vbox_version&quot;</span>  <span class="stringliteral">&quot;Virtualbox version&quot;</span>                                                <span class="stringliteral">&quot;6.1.14&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;vbox_version_full&quot;</span> <span class="stringliteral">&quot;Virtualbox full version&quot;</span>                                       <span class="stringliteral">&quot;6.1.14a&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;lineno_patch&quot;</span> <span class="stringliteral">&quot;Line patched against vbox-img.cpp in virtualbox source code&quot;</span>        <span class="stringliteral">&quot;797&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;stage3&quot;</span>      <span class="stringliteral">&quot;Path to stage3 archive&quot;</span>                                              <span class="stringliteral">&quot;stage3.tar.xz&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;create_squashfs&quot;</span>  <span class="stringliteral">&quot;(Re)create the squashfs filesystem&quot;</span>                             <span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;vmtype&quot;</span>      <span class="stringliteral">&quot;gui or headless (silent)&quot;</span>                                            <span class="stringliteral">&quot;headless&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;kernel_config&quot;</span>  <span class="stringliteral">&quot;Use a custom kernel config file&quot;</span>                                  <span class="stringliteral">&quot;.config&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;language&quot;</span>    <span class="stringliteral">&quot;Set default login keyboard layout&quot;</span>                                   <span class="stringliteral">&quot;us&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;burn&quot;</span>        <span class="stringliteral">&quot;Burn to optical disc. Argument is either a device label (e.g. cdrom, sr0) or a mountpoint directory.&quot;</span>  <span class="stringliteral">&quot;false&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;scsi_address&quot;</span> <span class="stringliteral">&quot;In case of several optical disc burners, specify the SCSI address as x,y,z&quot;</span>  <span class="stringliteral">&quot;0,0,0&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;usb_device&quot;</span>  <span class="stringliteral">&quot;Create Gentoo OS on external device. Argument is either a device label (e.g. sdb1, hdb1), or a mountpoint directory (if mounted), or a few consecutive letters of the model (e.g. &#39;Samsu&#39;, &#39;PNY&#39; or &#39;Kingst&#39;), if there is just one such.&quot;</span>    <span class="stringliteral">&quot;&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;usb_installer&quot;</span> <span class="stringliteral">&quot;Create Gentoo clone installer on external device. Argument is either a device label (e.g. sdb2, hdb2), or a mountpoint directory (if mounted), or a few consecutive letters of the model, if there is just one such. If unspecified, **usb_device** value will be used. OS Gentoo will be replaced by Clonezilla installer.&quot;</span>  <span class="stringliteral">&quot;&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;disable_md5_check&quot;</span> <span class="stringliteral">&quot;Disable MD5 checkums verification after downloads&quot;</span>             <span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;cleanup&quot;</span>       <span class="stringliteral">&quot;Clean up archives, temporary images and virtual machine after successful completion&quot;</span>  <span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;debug_mode&quot;</span>  <span class="stringliteral">&quot;Do not clean up mkgentoo custom logs at root of gentoo system files before VM shutdown&quot;</span>  <span class="stringliteral">&quot;false&quot;</span></div>
<div class="line">     <span class="stringliteral">&quot;help&quot;</span>          <span class="stringliteral">&quot;\t This help&quot;</span>                                                         <span class="stringliteral">&quot;&quot;</span></div>
<div class="line"> </div>
<div class="line">    )</div>
<div class="line"> </div>
<div class="line">ARRAY_LENGTH=$((${#<a class="code" href="mkgentoo_8sh.html#a214cb10953cb8efbb6a2092fdb4ff6fd">ARR</a>[*]}/3))</div>
<div class="line"> </div>
<div class="line">ISO=<span class="stringliteral">&quot;downloaded.iso&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># test_cli</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># Analyses commandline</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># arguments :</span></div>
<div class="line"><span class="preprocessor">#  cli          Commandline</span></div>
<div class="line"><span class="preprocessor"># creates globals of the form VAR=arg  when there is var=arg on commandline</span></div>
<div class="line"><span class="preprocessor"># otherwise assigns default values VAR=defaults (3rd argument in array ARR)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> test_cli {</div>
<div class="line"><span class="preprocessor">   # check version</span></div>
<div class="line">   local vbox_version=$(VBoxManage -v)</div>
<div class="line">   local version_major=$(echo ${vbox_version} | sed -E <span class="stringliteral">&#39;s/([0-9]+)\..*/\1/&#39;</span>)</div>
<div class="line">   local version_minor=$(echo ${vbox_version} | sed -E <span class="stringliteral">&#39;s/[0-9]+\.([0-9]+)\..*/\1/&#39;</span>)</div>
<div class="line">   local version_index=$(echo ${vbox_version} | sed -E <span class="stringliteral">&#39;s/[0-9]+\.[0-9]+\.([0-9][0-9]).*/\1/&#39;</span>)</div>
<div class="line">   <span class="keywordflow">if</span> test ${version_major} -lt 6 -o ${version_minor} -lt 1 -o ${version_index} -lt 10; then</div>
<div class="line">       echo <span class="stringliteral">&quot;VirtualBox must be at least version 6.1.14&quot;</span></div>
<div class="line">       echo <span class="stringliteral">&quot;Please update and reinstall&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   local sw=${<a class="code" href="mkgentoo_8sh.html#a214cb10953cb8efbb6a2092fdb4ff6fd">ARR</a>[$(($1 * 3))]}</div>
<div class="line">   local desc=${<a class="code" href="mkgentoo_8sh.html#a214cb10953cb8efbb6a2092fdb4ff6fd">ARR</a>[$(($1 * 3 + 1))]}</div>
<div class="line">   local <span class="keywordflow">default</span>=${<a class="code" href="mkgentoo_8sh.html#a214cb10953cb8efbb6a2092fdb4ff6fd">ARR</a>[$(($1 * 3 + 2))]}</div>
<div class="line">   local vm_arg=$(echo ${CLI} | sed -E <span class="stringliteral">&quot;s/(^${sw}|.* ${sw})=([^ ]+).*/\2/&quot;</span>)</div>
<div class="line">   ISO_OUTPUT=$(echo ${CLI} | sed -E <span class="stringliteral">&#39;s/.*(\b\w+)\.(iso|ISO)/\1\.iso/&#39;</span>)</div>
<div class="line">   <span class="keywordflow">if</span> test <span class="stringliteral">&quot;${ISO_OUTPUT}&quot;</span> != <span class="stringliteral">&quot;&quot;</span> -a <span class="stringliteral">&quot;${ISO_OUTPUT}&quot;</span> != <span class="stringliteral">&quot;${CLI}&quot;</span>; then</div>
<div class="line">       echo <span class="stringliteral">&quot;Build Gentoo distribution to bootable ISO output ${ISO_OUTPUT}&quot;</span></div>
<div class="line">       CREATE_ISO=<span class="stringliteral">&quot;true&quot;</span></div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">       echo <span class="stringliteral">&quot;You did not indicate an ISO output file.&quot;</span></div>
<div class="line">       !    echo <span class="stringliteral">&quot;A Virtual machine will be created with name Gentoo under $HOME&quot;</span></div>
<div class="line">       CREATE_ISO=<span class="stringliteral">&quot;false&quot;</span></div>
<div class="line">   fi</div>
<div class="line">   VAR=$(echo ${sw} | tr <span class="stringliteral">&quot;[a-z]&quot;</span> <span class="stringliteral">&quot;[A-Z]&quot;</span>)</div>
<div class="line">   <span class="keywordflow">if</span> test <span class="stringliteral">&quot;${vm_arg}&quot;</span> != <span class="stringliteral">&quot;&quot;</span> -a <span class="stringliteral">&quot;${vm_arg}&quot;</span> != <span class="stringliteral">&quot;${CLI}&quot;</span> ; then  # No args or no option</div>
<div class="line">       echo <span class="stringliteral">&quot;${desc}&quot;</span> = <span class="stringliteral">&quot;${vm_arg}&quot;</span> | sed <span class="stringliteral">&#39;s/\\t //&#39;</span></div>
<div class="line">       eval <span class="stringliteral">&quot;${VAR}&quot;</span>=<span class="stringliteral">&quot;\&quot;${vm_arg}\&quot;&quot;</span></div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">       echo <span class="stringliteral">&quot;${desc}&quot;</span> = <span class="stringliteral">&quot;${default}&quot;</span> | sed <span class="stringliteral">&#39;s/\\t //&#39;</span></div>
<div class="line">       eval <span class="stringliteral">&quot;${VAR}&quot;</span>=<span class="stringliteral">&quot;\&quot;${default}\&quot;&quot;</span></div>
<div class="line">   fi</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># check_md5sum</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># Checks md5sums in file MD5SUMS</span></div>
<div class="line"><span class="preprocessor"># Returns 0 on success otherwise -1 on exit</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> check_md5sum {</div>
<div class="line">   local ref=$(cat MD5SUMS | grep <span class="stringliteral">&quot;$1&quot;</span> | cut -f 1 -d<span class="charliteral">&#39; &#39;</span>)</div>
<div class="line">   downloaded=$(md5sum $1 | cut -f 1 -d<span class="charliteral">&#39; &#39;</span>)</div>
<div class="line">   <span class="keywordflow">if</span> test ${downloaded} = ${ref}; then</div>
<div class="line">       <span class="keywordflow">return</span> 0</div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">       echo <span class="stringliteral">&quot;MD5 checkum for $1 is not correct. Please download manually...&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># help</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># Prints usage</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> help_md {</div>
<div class="line">   echo <span class="stringliteral">&quot;**USAGE:**  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;**mkgentoo**  [[switch=argument]...]  filename.iso  [1]  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;**mkgentoo**  [[switch=argument]...]                [2]  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;**mkgentoo**  help[=md]                             [3]  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;Usage [1] creates a bootable ISO output file with a current Gentoo distribution.  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;Usage [2] creates a VirtualBox VDI dynamic disk and a virtual machine with name Gentoo.  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;Usage [3] prints this help, in markdown form if argument &#39;md&#39; is specified.  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;Warning: you should have at least 55 GB of free disk space in the current directory or in vmpath if specified.  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;**Switches:**  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;Boolean values are either &#39;true&#39; or &#39;false&#39;. For example, to build a minimal distribution, specify:  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;&gt;  minimal=true  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;on command line.  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot; | switch | description | default value |  &quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot; |:-----:|:--------:|:-----:|  &quot;</span></div>
<div class="line">   <span class="keywordflow">for</span> ((i=0; i&lt;${ARRAY_LENGTH}; i++)); <span class="keywordflow">do</span></div>
<div class="line">       local sw=$(($i*3))</div>
<div class="line">       local desc=$(($i*3+1))</div>
<div class="line">       local def=$(($i*3+2))</div>
<div class="line">       echo -e <span class="stringliteral">&quot;| ${ARR[$sw]} \t| ${ARR[$desc]} \t| [${ARR[$def]}] |  &quot;</span></div>
<div class="line">   done</div>
<div class="line">   echo</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> help {</div>
<div class="line">   help_md | sed <span class="stringliteral">&#39;s/[\*\|&gt;]//g&#39;</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># fetch_livecd</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># Downloads Gentoo install CD</span></div>
<div class="line"><span class="preprocessor"># Caches it as ${ISO}</span></div>
<div class="line"><span class="preprocessor"># Returns 0 on success or -1 on exit</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> fetch_livecd {</div>
<div class="line">   local CACHED_ISO=<span class="stringliteral">&quot;install-${PROCESSOR}-minimal.iso&quot;</span></div>
<div class="line">   <span class="keywordflow">if</span> test ${DOWNLOAD} = <span class="stringliteral">&quot;false&quot;</span>; then</div>
<div class="line">       <span class="keywordflow">if</span> test -f ${CACHED_ISO}; then</div>
<div class="line">           cp -vf ${CACHED_ISO} ${ISO}</div>
<div class="line">           LIVECD=${ISO}</div>
<div class="line">           <span class="keywordflow">return</span> 0</div>
<div class="line">       <span class="keywordflow">else</span></div>
<div class="line">           echo <span class="stringliteral">&quot;No ISO file was found, please rerun with download=true&quot;</span></div>
<div class="line">           exit -1</div>
<div class="line">       fi</div>
<div class="line">   fi</div>
<div class="line">   rm install-${PROCESSOR}-minimal*\.iso*</div>
<div class="line">   rm latest-install-${PROCESSOR}-minimal*\.txt*</div>
<div class="line">   local downloaded=<span class="stringliteral">&quot;&quot;</span></div>
<div class="line">   wget ${MIRROR}/releases/${PROCESSOR}/autobuilds/latest-install-${PROCESSOR}-minimal.txt</div>
<div class="line">   <span class="keywordflow">if</span> test $? != 0; then</div>
<div class="line">       echo <span class="stringliteral">&quot;Could not download live CD from Gentoo mirror&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   local current=$(cat latest-install-${PROCESSOR}-minimal.txt | grep <span class="stringliteral">&quot;install-${PROCESSOR}-minimal.*.iso&quot;</span> | sed -E <span class="stringliteral">&#39;s/iso.*$/iso/&#39;</span> )</div>
<div class="line">   local downloaded=$(basename ${current})</div>
<div class="line">   echo <span class="stringliteral">&quot;Downloading $current...&quot;</span></div>
<div class="line">   wget <span class="stringliteral">&quot;${MIRROR}/releases/${PROCESSOR}/autobuilds/${current}&quot;</span></div>
<div class="line">   <span class="keywordflow">if</span> test $? != 0; then</div>
<div class="line">       echo <span class="stringliteral">&quot;Could not download live CD&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">       <span class="keywordflow">if</span> test ${DISABLE_MD5_CHECK} = <span class="stringliteral">&quot;false&quot;</span>; then</div>
<div class="line">           check_md5sum ${downloaded}</div>
<div class="line">       fi</div>
<div class="line">       <span class="keywordflow">if</span> test -f ${downloaded}; then</div>
<div class="line">           cp -vf ${downloaded} ${CACHED_ISO}</div>
<div class="line">           mv ${downloaded} ${ISO}</div>
<div class="line">           <span class="keywordflow">if</span> test -f ${ISO}; then</div>
<div class="line">               LIVECD=${ISO}</div>
<div class="line">           <span class="keywordflow">else</span></div>
<div class="line">               echo <span class="stringliteral">&quot;No active ISO (downloaded.iso) file!&quot;</span></div>
<div class="line">               exit -1</div>
<div class="line">           fi</div>
<div class="line">       <span class="keywordflow">else</span></div>
<div class="line">           echo <span class="stringliteral">&quot;Could not find downloaded live CD ${downloaded}&quot;</span></div>
<div class="line">           exit -1</div>
<div class="line">       fi</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">return</span> 0</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># fetch_stage3</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># Downloads a fresh stage3 Gentoo archive</span></div>
<div class="line"><span class="preprocessor"># Caches it as ${STAGE3}</span></div>
<div class="line"><span class="preprocessor"># Returns 0 on success or -1 on exit</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> fetch_stage3 {</div>
<div class="line"><span class="preprocessor">   # Fetching stage3 tarball</span></div>
<div class="line">   local CACHED_STAGE3=<span class="stringliteral">&quot;stage3-${PROCESSOR}.tar.xz&quot;</span></div>
<div class="line">   echo <span class="stringliteral">&quot;download_stage3=${DOWNLOAD_STAGE3}&quot;</span></div>
<div class="line">   <span class="keywordflow">if</span> test ${DOWNLOAD_STAGE3} = <span class="stringliteral">&quot;true&quot;</span>; then</div>
<div class="line">       echo <span class="stringliteral">&quot;Cleaning up stage3 data...&quot;</span></div>
<div class="line">       rm -vf latest-stage3*.txt*</div>
<div class="line">       echo <span class="stringliteral">&quot;Downloading stage3 data...&quot;</span></div>
<div class="line">       wget ${MIRROR}/releases/${PROCESSOR}/autobuilds/latest-stage3-${PROCESSOR}.txt</div>
<div class="line">       <span class="keywordflow">if</span> test $? != 0; then</div>
<div class="line">           echo <span class="stringliteral">&quot;Could not download stage3 from mirrors: ${MIRROR}/releases/${PROCESSOR}/autobuilds/latest-stage3-${PROCESSOR}.txt&quot;</span></div>
<div class="line">           exit -1</div>
<div class="line">       fi</div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">       <span class="keywordflow">if</span> ! test -f latest-stage3-${PROCESSOR}.txt; then</div>
<div class="line">           echo <span class="stringliteral">&quot;No stage 3 download information available!&quot;</span></div>
<div class="line">           echo <span class="stringliteral">&quot;Rerun with download_stage3=true&quot;</span></div>
<div class="line">           exit -1</div>
<div class="line">       fi</div>
<div class="line">   fi</div>
<div class="line">   local current=$(cat latest-stage3-${PROCESSOR}.txt | grep <span class="stringliteral">&quot;stage3-${PROCESSOR}.*.tar.xz&quot;</span> | cut -f 1 -d<span class="charliteral">&#39; &#39;</span>)</div>
<div class="line">   <span class="keywordflow">if</span> test ${DOWNLOAD_STAGE3} = <span class="stringliteral">&quot;true&quot;</span>; then</div>
<div class="line">       echo <span class="stringliteral">&quot;Cleaning up stage3 archives(s)...&quot;</span></div>
<div class="line">       rm -vf stage3-${PROCESSOR}-*tar.xz*</div>
<div class="line">       rm  ${STAGE3}</div>
<div class="line">       echo <span class="stringliteral">&quot;Downloading ${current}...&quot;</span></div>
<div class="line">       wget <span class="stringliteral">&quot;${MIRROR}/releases/${PROCESSOR}/autobuilds/${current}&quot;</span></div>
<div class="line">       <span class="keywordflow">if</span> test $? != 0; then</div>
<div class="line">           echo <span class="stringliteral">&quot;Could not download stage3 tarball from mirror: ${MIRROR}/releases/${PROCESSOR}/autobuilds/${current}&quot;</span></div>
<div class="line">           exit -1</div>
<div class="line">       fi</div>
<div class="line">       <span class="keywordflow">if</span> test ${DISABLE_MD5_CHECK} = <span class="stringliteral">&quot;false&quot;</span>; then</div>
<div class="line">           check_md5sum $(basename ${current})</div>
<div class="line">       fi</div>
<div class="line">       cp -vf $(echo ${current} | sed <span class="stringliteral">&#39;s/.*stage3/stage3/&#39;</span>)  ${CACHED_STAGE3}</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> ! test -f <span class="stringliteral">&quot;${CACHED_STAGE3}&quot;</span>; then</div>
<div class="line">       echo <span class="stringliteral">&quot;No stage3 tarball!&quot;</span></div>
<div class="line">       echo <span class="stringliteral">&quot;Rerun with download_stage3=true&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   cp -vf ${CACHED_STAGE3} ${STAGE3}</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># make_boot_from_livecd</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># Unless create_squashfs=false is given on commandline</span></div>
<div class="line"><span class="preprocessor"># tweaks the Gentoo minimal install CD so that the custom-</span></div>
<div class="line"><span class="preprocessor"># made shell scripts are included into the squashfs filesystem</span></div>
<div class="line"><span class="preprocessor"># as well as the stage3 archive.</span></div>
<div class="line"><span class="preprocessor"># to be run in the ${VM} virtual machine</span></div>
<div class="line"><span class="preprocessor"># Returns  0 on success or -1 on exit</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> make_boot_from_livecd {</div>
<div class="line">   <span class="keywordflow">if</span> ! test -f ${ISO}; then</div>
<div class="line">       echo <span class="stringliteral">&quot;No active ISO file in current directory!&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> test ${CREATE_SQUASHFS} = <span class="stringliteral">&quot;false&quot;</span>; then</div>
<div class="line">       <span class="keywordflow">return</span> 0;</div>
<div class="line">   fi</div>
<div class="line">   mountpoint -q mnt &amp;&amp; sudo umount -l mnt</div>
<div class="line">   <span class="keywordflow">if</span> test -d mnt; then</div>
<div class="line">       sudo rm -rf mnt</div>
<div class="line">   fi</div>
<div class="line">   mkdir mnt</div>
<div class="line">   sudo mount -oloop ${ISO} mnt/</div>
<div class="line">   ! mountpoint -q mnt &amp;&amp; echo <span class="stringliteral">&quot;ISO not mounted!&quot;</span> &amp;&amp; exit -1</div>
<div class="line">   <span class="keywordflow">if</span> test -d mnt2; then</div>
<div class="line">       sudo rm -rf mnt2</div>
<div class="line">   fi</div>
<div class="line">   mkdir mnt2</div>
<div class="line">   rsync -av mnt/ mnt2</div>
<div class="line">   cd mnt2/isolinux</div>
<div class="line">   sed -i <span class="stringliteral">&#39;s/timeout.*/timeout 1/&#39;</span> isolinux.cfg</div>
<div class="line">   sed -i <span class="stringliteral">&#39;s/ontimeout.*/ontimeout gentoo/&#39;</span> isolinux.cfg</div>
<div class="line">   cd ..</div>
<div class="line">   sudo unsquashfs image.squashfs</div>
<div class="line">   <span class="keywordflow">if</span> test $? != 0; then</div>
<div class="line">       echo <span class="stringliteral">&quot;unsquashfs failed !&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   cd ..</div>
<div class="line">   <span class="keywordflow">if</span> ! test -f scripts/mkvm.sh; then</div>
<div class="line">       echo <span class="stringliteral">&quot;No mkvm.sh script!&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> ! test -f scripts/mkvm_chroot.sh; then</div>
<div class="line">       echo <span class="stringliteral">&quot;No mkvm_chroot.sh script!&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> test <span class="stringliteral">&quot;${MINIMAL}&quot;</span> = <span class="stringliteral">&quot;true&quot;</span> -a <span class="stringliteral">&quot;${ELIST}&quot;</span> = <span class="stringliteral">&quot;ebuilds.list&quot;</span>; then</div>
<div class="line">       cp -vf ${ELIST}.minimal ${ELIST}</div>
<div class="line">   <span class="keywordflow">else</span></div>
<div class="line">       cp -vf ${ELIST}.complete ${ELIST}</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> ! test -f ${ELIST}; then</div>
<div class="line">       echo <span class="stringliteral">&quot;No ebuild list!&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> ! test -f ${STAGE3}; then</div>
<div class="line">       echo <span class="stringliteral">&quot;No stage3 archive!&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> ! test -f ${KERNEL_CONFIG}; then</div>
<div class="line">       echo <span class="stringliteral">&quot;No kernel configuration file!&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   local sqrt=<span class="stringliteral">&quot;mnt2/squashfs-root/root/&quot;</span></div>
<div class="line">   sudo chown fab ${sqrt}</div>
<div class="line">   mv -vf ${STAGE3} ${sqrt}</div>
<div class="line">   cp -vf scripts/mkvm.sh ${sqrt}</div>
<div class="line">   chmod +x ${sqrt}mkvm.sh</div>
<div class="line">   cp -vf scripts/mkvm_chroot.sh ${sqrt}</div>
<div class="line">   chmod +x ${sqrt}mkvm_chroot.sh</div>
<div class="line">   cp -vf ${ELIST} ${sqrt}</div>
<div class="line">   cp -vf ${KERNEL_CONFIG} ${sqrt}</div>
<div class="line">   cd ${sqrt}</div>
<div class="line">   rc=<span class="stringliteral">&quot;.bashrc&quot;</span></div>
<div class="line">   cp -vf /etc/bash.bashrc ${rc}</div>
<div class="line">   <span class="keywordflow">for</span> ((i=0; i&lt;ARRAY_LENGTH; i++)); <span class="keywordflow">do</span></div>
<div class="line">       local  capname=${<a class="code" href="mkgentoo_8sh.html#a214cb10953cb8efbb6a2092fdb4ff6fd">ARR</a>[$((i * 3))]^^}</div>
<div class="line">       local  expstring=<span class="stringliteral">&quot;export ${capname}=\&quot;${!capname}\&quot;&quot;</span></div>
<div class="line">       echo <span class="stringliteral">&quot;${expstring}&quot;</span></div>
<div class="line">       echo <span class="stringliteral">&quot;${expstring}&quot;</span> &gt;&gt; ${rc}</div>
<div class="line">   done</div>
<div class="line">   echo  <span class="stringliteral">&quot;/bin/bash mkvm.sh&quot;</span>  &gt;&gt; ${rc}</div>
<div class="line">   cd ../..</div>
<div class="line">   rm  image.squashfs</div>
<div class="line">   sudo mksquashfs squashfs-root/ image.squashfs</div>
<div class="line">   sudo rm -rf squashfs-root/</div>
<div class="line">   cd ..</div>
<div class="line">   mkisofs -J -R -o  ${ISO} -b isolinux/isolinux.bin  -c isolinux/boot.cat  -no-emul-boot -boot-load-size 4  -boot-info-table  mnt2</div>
<div class="line">   <span class="keywordflow">if</span> test $? != 0; then</div>
<div class="line">       echo <span class="stringliteral">&quot;mkisofs could not recreate the ISO file to boot virtual machine ${VM}&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">   sudo umount -l mnt</div>
<div class="line">   sudo chown -R fab .</div>
<div class="line">   rm -rvf mnt</div>
<div class="line">   rm -rvf mnt2</div>
<div class="line">   <span class="keywordflow">return</span> 0</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># test_vm_running</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># Checks if VM as first named argument exists and is running</span></div>
<div class="line"><span class="preprocessor"># Returns 0 on success and 1 is VM is not listed or not running</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> test_vm_running {</div>
<div class="line">   <span class="keywordflow">if</span> test <span class="stringliteral">&quot;$(VBoxManage list vms | grep &quot;</span>$1<span class="stringliteral">&quot;)&quot;</span> != <span class="stringliteral">&quot;&quot;</span> -a <span class="stringliteral">&quot;$(VBoxManage list runningvms | grep &quot;</span>$1<span class="stringliteral">&quot;)&quot;</span> != <span class="stringliteral">&quot;&quot;</span>; then</div>
<div class="line">       <span class="keywordflow">return</span> 0</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">return</span> 1</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># delete_vm</span></div>
<div class="line"><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"># Powers off, possibly with emergency stop, the VM names as first argument</span></div>
<div class="line"><span class="preprocessor"># Unregisters it</span></div>
<div class="line"><span class="preprocessor"># Deletes its folder structure and hard drive (default is &quot;vdi&quot; as a second argument)</span></div>
<div class="line"><span class="preprocessor"># Returns 0 if Directory and hard drive could be erased, otherwise the OR value of both</span></div>
<div class="line"><span class="preprocessor"># erasing commands</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> delete_vm  {</div>
<div class="line">   <span class="keywordflow">if</span> test_vm_running <span class="stringliteral">&quot;$1&quot;</span>; then</div>
<div class="line">       VBoxManage controlvm <span class="stringliteral">&quot;$1&quot;</span> poweroff</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> test_vm_running <span class="stringliteral">&quot;$1&quot;</span>; then</div>
<div class="line">       VBoxManage startvm $1 --type emergencystop</div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> test <span class="stringliteral">&quot;$(VBoxManage list vms | grep &quot;</span>$1<span class="stringliteral">&quot;)&quot;</span> != <span class="stringliteral">&quot;&quot;</span>; then</div>
<div class="line">       VBoxManage unregistervm <span class="stringliteral">&quot;$1&quot;</span> --<span class="keyword">delete</span></div>
<div class="line">   fi</div>
<div class="line">   <span class="keywordflow">if</span> test -d <span class="stringliteral">&quot;${VMPATH}/$1&quot;</span>; then</div>
<div class="line">       sudo rm -rvf  <span class="stringliteral">&quot;${VMPATH}/$1&quot;</span></div>
<div class="line">   fi</div>
<div class="line">   res=$?</div>
<div class="line">   <span class="keywordflow">if</span> test <span class="stringliteral">&quot;$2&quot;</span> != <span class="stringliteral">&quot;&quot;</span> -a -f <span class="stringliteral">&quot;${VMPATH}/$1.$2&quot;</span>; then</div>
<div class="line">       sudo rm -f   <span class="stringliteral">&quot;${VMPATH}/$1.$2&quot;</span></div>
<div class="line">   fi</div>
<div class="line">   res=$(($? | ${res}))</div>
<div class="line">   <span class="keywordflow">return</span> ${res}</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># mkvm.sh should be adjacent to mkgentoo.sh</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> create_vm {</div>
<div class="line">   export <a name="a1"></a><a class="code" href="mkgentoo_8sh.html#ad1451b50408769582d8f5bd4254fe7b1">PATH</a>=${<a class="code" href="mkgentoo_8sh.html#ad1451b50408769582d8f5bd4254fe7b1">PATH</a>}:${VBPATH}</div>
<div class="line">   cd ${<a name="a2"></a><a class="code" href="build__virtualbox_8sh.html#a62ad76d689932a98f7cc9667b6fa903d">VMPATH</a>}</div>
<div class="line">   delete_vm ${VM} <span class="stringliteral">&quot;vdi&quot;</span></div>
<div class="line">   VBoxManage createvm --name <span class="stringliteral">&quot;${VM}&quot;</span> --ostype gentoo_64  --<span class="keyword">register</span>  --basefolder <span class="stringliteral">&quot;${VMPATH}&quot;</span></div>
<div class="line">   VBoxManage modifyvm <span class="stringliteral">&quot;${VM}&quot;</span> --cpus ${NCPUS} --cpu-profile host --memory ${MEM} --vram 256 --ioapic on --usbxhci on --usbehci on</div>
<div class="line">   VBoxManage createhd --filename <span class="stringliteral">&quot;${VM}.vdi&quot;</span> --size ${SIZE} --variant Standard</div>
<div class="line">   VBoxManage storagectl <span class="stringliteral">&quot;${VM}&quot;</span> --name <span class="stringliteral">&quot;SATA Controller&quot;</span> --add sata --bootable on</div>
<div class="line">   VBoxManage storageattach <span class="stringliteral">&quot;${VM}&quot;</span> --storagectl <span class="stringliteral">&quot;SATA Controller&quot;</span>  --medium <span class="stringliteral">&quot;${VM}.vdi&quot;</span> --port 0 --device 0 --type hdd</div>
<div class="line">   VBoxManage storagectl <span class="stringliteral">&quot;${VM}&quot;</span> --name <span class="stringliteral">&quot;IDE Controller&quot;</span> --add ide</div>
<div class="line">   VBoxManage storageattach <span class="stringliteral">&quot;${VM}&quot;</span> --storagectl <span class="stringliteral">&quot;IDE Controller&quot;</span>  --port 0  --device 0   --type dvddrive --medium ${LIVECD}  --tempeject on</div>
<div class="line">   VBoxManage storageattach <span class="stringliteral">&quot;${VM}&quot;</span> --storagectl <span class="stringliteral">&quot;IDE Controller&quot;</span>  --port 0  --device 1   --type dvddrive --medium emptydrive</div>
<div class="line">   VBoxManage startvm <span class="stringliteral">&quot;${VM}&quot;</span> --type ${VMTYPE}</div>
<div class="line"><span class="preprocessor">   # VM is created in a separate process</span></div>
<div class="line"><span class="preprocessor">   # Wait for it to come to end</span></div>
<div class="line"><span class="preprocessor">   # Test if still running every minute</span></div>
<div class="line">   <span class="keywordflow">while</span> test_vm_running ${VM}; <span class="keywordflow">do</span></div>
<div class="line">       echo <span class="stringliteral">&quot;${VM} running...&quot;</span></div>
<div class="line">       sleep 60</div>
<div class="line">   done</div>
<div class="line">   VBoxManage modifyhd <span class="stringliteral">&quot;${VM}.vdi&quot;</span> --compact</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> clonezilla_to_iso {</div>
<div class="line">   <span class="keywordflow">if</span> ! test -f <span class="stringliteral">&quot;${VMPATH}/$2&quot;</span>/syslinux/isohdpfx.bin; then</div>
<div class="line">       sudo cp -vf ${<a class="code" href="build__virtualbox_8sh.html#a62ad76d689932a98f7cc9667b6fa903d">VMPATH</a>}/clonezilla/syslinux/isohdpfx.bin <span class="stringliteral">&quot;${VMPATH}/$2&quot;</span>/syslinux</div>
<div class="line">   fi</div>
<div class="line">   xorriso -as mkisofs   -isohybrid-mbr <span class="stringliteral">&quot;$2&quot;</span>/syslinux/isohdpfx.bin  \</div>
<div class="line">           -c syslinux/boot.cat   -b syslinux/isolinux.bin   -no-emul-boot \</div>
<div class="line">           -boot-load-size 4   -boot-info-table   -eltorito-alt-boot   -e boot/grub/efiboot.img \</div>
<div class="line">           -no-emul-boot   -isohybrid-gpt-basdat   -o <span class="stringliteral">&quot;$1&quot;</span>  <span class="stringliteral">&quot;$2&quot;</span></div>
<div class="line">   <span class="keywordflow">if</span> test $? != 0; then</div>
<div class="line">       echo <span class="stringliteral">&quot;Could not create ISO image from ISO package creation directory&quot;</span></div>
<div class="line">       exit -1</div>
<div class="line">   fi</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> process_clonezilla_iso {</div>
<div class="line">   fetch_clonezilla_iso</div>
<div class="line">   <span class="keywordflow">for</span> i in proc sys dev run; <span class="keywordflow">do</span> sudo mount -B /$i squashfs-root/$i; done</div>
<div class="line">   sudo chroot squashfs-root</div>
<div class="line">   sudo mkdir /boot</div>
<div class="line">   sudo apt update -yq</div>
<div class="line">   sudo apt upgrade -yq &lt;&lt;&lt; $(echo N)</div>
<div class="line">   local headers=$(apt-cache search ^linux-headers | tail -n1 | cut -f 1 -d<span class="charliteral">&#39; &#39;</span>)</div>
<div class="line">   local kernel=$(apt-cache search ^linux-image | grep -v <span class="keywordtype">unsigned</span> | tail -n1 | cut -f 1 -d<span class="charliteral">&#39; &#39;</span>)</div>
<div class="line">   sudo apt install -qy ${headers}</div>
<div class="line">   sudo apt install -qy ${kernel}</div>
<div class="line">   sudo apt install -qy build-essential gcc &lt;&lt;&lt; $(echo N)</div>
<div class="line">   sudo apt install -qy virtualbox-dkms</div>
<div class="line">   sudo apt install -qy virtualbox-guest-additions-iso</div>
<div class="line">   sudo mount -oloop /usr/share/virtualbox/VBoxGuestAdditions.iso /mnt</div>
<div class="line">   cd /mnt</div>
<div class="line">   /sbin/rcvboxadd quicksetup all</div>
<div class="line">   sudo /bin/bash VBoxLinuxAdditions.run</div>
<div class="line">   cd /</div>
<div class="line">   sudo umount /mnt</div>
<div class="line">   sudo apt remove -y -q ${headers} build-essential gcc  virtualbox-guest-additions-iso</div>
<div class="line">   sudo apt autoremove -y -q</div>
<div class="line">   exit</div>
<div class="line">   sudo cp -vf --dereference squashfs-root/boot/vmlinuz  vmlinuz</div>
<div class="line">   sudo cp -vf --dereference squashfs-root/boot/initrd.img  initrd.img</div>
<div class="line">   sudo rm -rf squashfs-root/boot</div>
<div class="line">   sudo rm -vf filesystem.squashfs</div>
<div class="line">   <span class="keywordflow">for</span> i in proc sys dev  run; <span class="keywordflow">do</span> sudo umount squashfs-root/$i; done</div>
<div class="line">   sudo mksquashfs squashfs-root filesystem.squashfs</div>
<div class="line">   sudo rm -rf squashfs-root/</div>
<div class="line">   cd <span class="stringliteral">&quot;${VMPATH}/mnt2&quot;</span></div>
<div class="line">   sudo cp -vf ../clonezilla/savedisk/isolinux.cfg  syslinux</div>
<div class="line">   cd <span class="stringliteral">&quot;${VMPATH}&quot;</span></div>
<div class="line">   sudo rm -vf ${CLONEZILLACD}</div>
<div class="line">   echo</div>
<div class="line">   clonezilla_to_iso ${CLONEZILLACD} <span class="stringliteral">&quot;mnt2&quot;</span></div>
<div class="line">   sudo rm -rf mnt2</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">function</span> build_virtualbox {</div>
<div class="line">   cd ${<a class="code" href="build__virtualbox_8sh.html#a62ad76d689932a98f7cc9667b6fa903d">VMPATH</a>}</div>
<div class="line">   cp -vf clonezilla/build<span class="comment">/* ${CLONEZILLACD}/live</span></div>
<div class="line"><span class="comment">   cd ${CLONEZILLACD}/live</span></div>
<div class="line"><span class="comment">   ./build_clonezilla.sh</span></div>
<div class="line"><span class="comment">   cd ${VMPATH}</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function create_iso_vm {</span></div>
<div class="line"><span class="comment">   cd ${VMPATH}</span></div>
<div class="line"><span class="comment">   process_clonezilla_iso</span></div>
<div class="line"><span class="comment">   gpasswd -a ${USER} -g vboxusers</span></div>
<div class="line"><span class="comment">   chgrp vboxusers &quot;ISOFILES/home/partimag/image&quot;</span></div>
<div class="line"><span class="comment">   delete_vm ${ISOVM}</span></div>
<div class="line"><span class="comment">   VBoxManage createvm --name &quot;${ISOVM}&quot; --ostype ubuntu_64  --register  --basefolder &quot;${VMPATH}&quot;</span></div>
<div class="line"><span class="comment">   VBoxManage modifyvm &quot;${ISOVM}&quot; --cpus ${NCPUS} --cpu-profile host --memory ${MEM} --vram 256 --ioapic on --usbxhci on --usbehci on</span></div>
<div class="line"><span class="comment">   VBoxManage storagectl &quot;${ISOVM}&quot; --name &quot;SATA Controller&quot; --add sata --bootable on</span></div>
<div class="line"><span class="comment">   # This to avoid issues with already-used vdis in debug tests</span></div>
<div class="line"><span class="comment">   VBoxManage internalcommands sethduuid &quot;${ISOVM.vdi}&quot;</span></div>
<div class="line"><span class="comment">   VBoxManage storageattach &quot;${ISOVM}&quot; --storagectl &quot;SATA Controller&quot;  --medium &quot;${ISOVM}.vdi&quot; --port 0 --device 0 --type hdd</span></div>
<div class="line"><span class="comment">   VBoxManage storagectl &quot;${ISOVM}&quot; --name &quot;IDE Controller&quot; --add ide</span></div>
<div class="line"><span class="comment">   VBoxManage storageattach &quot;${ISOVM}&quot; --storagectl &quot;IDE Controller&quot;  --port 0  --device 0   --type dvddrive --medium ${CLONEZILLACD}  --tempeject on</span></div>
<div class="line"><span class="comment">   VBoxManage storageattach &quot;${ISOVM}&quot; --storagectl &quot;IDE Controller&quot;  --port 0  --device 1   --type dvddrive --medium emptydrive</span></div>
<div class="line"><span class="comment">   VBoxManage startvm &quot;${ISOVM}&quot; --type ${VMTYPE}</span></div>
<div class="line"><span class="comment">   # must be running to work: note, requests 6.1.14 at least</span></div>
<div class="line"><span class="comment">   VBoxManage sharedfolder add &quot;${ISOVM}&quot; --name shared --hostpath &quot;${VMPATH}/ISOFILES/home/partimag/image&quot;  --automount --auto-mount-point &quot;/home/partimag&quot; --transient</span></div>
<div class="line"><span class="comment">   while test_vm_running ${ISOVM}; do</span></div>
<div class="line"><span class="comment">       echo &quot;${ISOVM} running...&quot;</span></div>
<div class="line"><span class="comment">       sleep 60</span></div>
<div class="line"><span class="comment">   done</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"># Gives device from mount folder input</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function get_device {</span></div>
<div class="line"><span class="comment">   if test -d &quot;$1&quot;; then</span></div>
<div class="line"><span class="comment">       device=$(findmnt --raw --first -a -n -c $1 | cut -f2 -d&#39; &#39;)</span></div>
<div class="line"><span class="comment">   else</span></div>
<div class="line"><span class="comment">       if is_block_device &quot;$1&quot;; then</span></div>
<div class="line"><span class="comment">           echo &quot;$1&quot;</span></div>
<div class="line"><span class="comment">       else</span></div>
<div class="line"><span class="comment">           echo &quot;$1 is neither a mountpoint nor a block device&quot;</span></div>
<div class="line"><span class="comment">           exit -1</span></div>
<div class="line"><span class="comment">       fi</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   echo ${device}</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function list_block_devices {</span></div>
<div class="line"><span class="comment">   echo  &quot;$(lsblk -a -n -o KNAME | grep -v loop)&quot;</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"># Returns 0 (true) if input is a block device otherwise 1</span></div>
<div class="line"><span class="comment">function is_block_device {</span></div>
<div class="line"><span class="comment">   local devices=$(list_block_devices)</span></div>
<div class="line"><span class="comment">   grep -q &quot;$1&quot; &lt;&lt;&lt; &quot;${devices}&quot; &amp;&amp; return 0</span></div>
<div class="line"><span class="comment">   return 1</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"># Gives mount folder from device label input</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function get_mountpoint {</span></div>
<div class="line"><span class="comment">   if is_block_device &quot;$1&quot;; then</span></div>
<div class="line"><span class="comment">       echo &quot;$1  is not a block device!&quot;</span></div>
<div class="line"><span class="comment">       echo &quot;Device labels should be in the following list:&quot;</span></div>
<div class="line"><span class="comment">       echo $(list_block_devices)</span></div>
<div class="line"><span class="comment">       exit -1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   echo &quot;$(findmnt --raw --first -a -n -c &quot;$1&quot; | cut -f1 -d&#39; &#39;)&quot;</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment">function clone_vm_to_usb {</span></div>
<div class="line"><span class="comment">   # Test whether USB_DEVICE is a mountpoint or a block device label</span></div>
<div class="line"><span class="comment">   USB_DEVICE=$(get_device ${USB_DEVICE})</span></div>
<div class="line"><span class="comment">   # Should not occur, only for paranoia</span></div>
<div class="line"><span class="comment">   if test &quot;${USB_DEVICE}&quot; = &quot;&quot;; then</span></div>
<div class="line"><span class="comment">       echo &quot;Could not set USB device ${USB_DEVICE}&quot;</span></div>
<div class="line"><span class="comment">       exit -1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   # Using the custom-patched version of the vbox-img utility:</span></div>
<div class="line"><span class="comment">   bin/vbox-img compact --filename &quot;${VMPATH}/${VM}.vdi&quot;</span></div>
<div class="line"><span class="comment">   bin/vbox-img convert --srcfilename &quot;${VMPATH}/${VM}.vdi&quot; --stdout --dstformat RAW | dd of=/dev/${USB_DEVICE} bs=4M status=progress</span></div>
<div class="line"><span class="comment">   if test $? = 0; then</span></div>
<div class="line"><span class="comment">       sync</span></div>
<div class="line"><span class="comment">       return $?</span></div>
<div class="line"><span class="comment">   else</span></div>
<div class="line"><span class="comment">       echo &quot;Could not convert dynamic virtual disk to raw USB device!&quot;</span></div>
<div class="line"><span class="comment">       exit -1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function clone_vm_to_raw {</span></div>
<div class="line"><span class="comment">   VBoxManage clonemedium &quot;${VMPATH}/${VM}.vdi&quot; &quot;${VMPATH}/tmpdisk.raw&quot; --format RAW</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function dd_to_usb {</span></div>
<div class="line"><span class="comment">   &quot;Bare metal copy of RAW disk to USB device...&quot;</span></div>
<div class="line"><span class="comment">   # Test whether USB_DEVICE is a mountpoint or a block device label</span></div>
<div class="line"><span class="comment">   USB_DEVICE=$(get_device ${USB_DEVICE})</span></div>
<div class="line"><span class="comment">   # Should not occur, only for paranoia</span></div>
<div class="line"><span class="comment">   if test &quot;${USB_DEVICE}&quot; = &quot;&quot;; then</span></div>
<div class="line"><span class="comment">       echo &quot;Could not set USB device ${USB_DEVICE}&quot;</span></div>
<div class="line"><span class="comment">       exit -1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   dd if=&quot;${VMPATH}/tmpdisk.raw&quot; of=/dev/${USB_DEVICE} bs=4M status=progress</span></div>
<div class="line"><span class="comment">   if test $? = 0; then</span></div>
<div class="line"><span class="comment">       echo &quot;Removing temporary RAW disk...&quot;</span></div>
<div class="line"><span class="comment">       rm -f ${VMPATH}/tmpdisk.raw</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   return $?</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function clonezilla_usb_to_image {</span></div>
<div class="line"><span class="comment">   find_ocs_sr=`which ocs-sr`</span></div>
<div class="line"><span class="comment">   if test &quot;$find_ocs_sr&quot; = &quot;&quot;; then</span></div>
<div class="line"><span class="comment">       echo &quot;Could not find ocs_sr !&quot;</span></div>
<div class="line"><span class="comment">       echo &quot;Install Clonezilla in a standard path or rerun after adding its parth to the PATH environment variable&quot;</span></div>
<div class="line"><span class="comment">       echo &quot;Note: Debian-based distributions provide a handy `clonezilla` package.&quot;</span></div>
<div class="line"><span class="comment">       exit -1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   # At this stage USB_DEVICE can no longer be a mountpoint as it has been previously converted to device label</span></div>
<div class="line"><span class="comment">   findmnt /dev/${USB_DEVICE}  &amp;&amp; echo &quot;Device ${USB_DEVICE} is mounted to: $(get_mountpoint /dev/${USB_DEVICE})&quot;  &amp;&amp; echo &quot;The external USB device should not be mounted&quot;  &amp;&amp; echo &quot;Trying to unmount...&quot; &amp;&amp; sudo umount -l /dev/${USB_DEVICE}</span></div>
<div class="line"><span class="comment">   if test $? =0; then</span></div>
<div class="line"><span class="comment">       echo &quot;Managed to unmount /dev/${USB_DEVICE}&quot;</span></div>
<div class="line"><span class="comment">   else</span></div>
<div class="line"><span class="comment">       echo &quot;Could not manage to unmount external USB device&quot;</span></div>
<div class="line"><span class="comment">       echo &quot;Unmount it manually and rerun.&quot;</span></div>
<div class="line"><span class="comment">       exit -1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   # double check</span></div>
<div class="line"><span class="comment">   if  test `findmnt /dev/${USB_DEVICE}`; then</span></div>
<div class="line"><span class="comment">       echo &quot;Impossible to unmount device ${USB_DEVICE}&quot;</span></div>
<div class="line"><span class="comment">       exit -1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   if test -d /home/partimag; then</span></div>
<div class="line"><span class="comment">       echo &quot;/home/partimag needs to be wiped out...&quot;</span></div>
<div class="line"><span class="comment">       echo &quot;Trying with user rights...&quot;</span></div>
<div class="line"><span class="comment">       rm -rf /home/partimag</span></div>
<div class="line"><span class="comment">       if test $? != 0; then</span></div>
<div class="line"><span class="comment">           echo &quot;Directory /home/partimag needs elevated rights...&quot;</span></div>
<div class="line"><span class="comment">           echo &quot;Waiting for sudo passwd...&quot;</span></div>
<div class="line"><span class="comment">           sudo  rm -rf /home/partimag</span></div>
<div class="line"><span class="comment">           if test $? != 0; then</span></div>
<div class="line"><span class="comment">               echo &quot;Could not fix /home/partimag issue.&quot;</span></div>
<div class="line"><span class="comment">               exit -1;</span></div>
<div class="line"><span class="comment">           fi</span></div>
<div class="line"><span class="comment">       fi</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   if test ${CLEANUP} = &quot;true&quot;; then</span></div>
<div class="line"><span class="comment">       echo &quot;Erasing virtual disk and virtual machine to save disk space...&quot;</span></div>
<div class="line"><span class="comment">       rm -f &quot;${VMPATH}/${VM}.vdi&quot;</span></div>
<div class="line"><span class="comment">       rm -rf &quot;${VMPATH}/${VM}&quot;</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   rm -rf ISOFILES/home/partimag/image/*</span></div>
<div class="line"><span class="comment">   if test $? != 0; then</span></div>
<div class="line"><span class="comment">       echo &quot;Could not remove old Clonezilla image&quot;</span></div>
<div class="line"><span class="comment">       exit -1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   sudo ln -s  ${VMPATH}/ISOFILES/home/partimag/image  /home/partimag</span></div>
<div class="line"><span class="comment">   /usr/sbin/ocs-sr -q2 -c -j2 -nogui -batch -gm -gmf -noabo -z5 \</span></div>
<div class="line"><span class="comment">                    -i 40960000000 -fsck -senc -p poweroff savedisk gentoo.img ${USB_DEVICE}</span></div>
<div class="line"><span class="comment">   if test $? = 0 -a -f /home/partimag/gentoo.img; then</span></div>
<div class="line"><span class="comment">       echo &quot;Cloning succeeded!&quot;</span></div>
<div class="line"><span class="comment">   else</span></div>
<div class="line"><span class="comment">       echo &quot;Cloning failed!&quot;</span></div>
<div class="line"><span class="comment">       exit -1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   return 0</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function burn_iso {</span></div>
<div class="line"><span class="comment">   res=0</span></div>
<div class="line"><span class="comment">   if test ${BURN} = &quot;true&quot;; then</span></div>
<div class="line"><span class="comment">       echo &quot;Burning installation medium to optical disc...&quot;</span></div>
<div class="line"><span class="comment">       if test &quot;${SCSI_ADDRESS}&quot; = &quot;&quot;; then</span></div>
<div class="line"><span class="comment">           cdrecord &quot;${LIVECD}&quot;</span></div>
<div class="line"><span class="comment">       else</span></div>
<div class="line"><span class="comment">           cdrecord &quot;${LIVECD}&quot; dev=${SCSI_ADDRESS}</span></div>
<div class="line"><span class="comment">       fi</span></div>
<div class="line"><span class="comment">       res=$?</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   return ${res}</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function create_install_usb_device {</span></div>
<div class="line"><span class="comment">   res=0</span></div>
<div class="line"><span class="comment">   if test ${USB_INSTALLER} = &quot;true&quot;; then</span></div>
<div class="line"><span class="comment">       echo &quot;Creating installation stick...&quot;</span></div>
<div class="line"><span class="comment">       dd if=${LIVECD} of=/dev/${USB_DEVICE} bs=4M status=progress</span></div>
<div class="line"><span class="comment">       res=$?</span></div>
<div class="line"><span class="comment">       sync</span></div>
<div class="line"><span class="comment">       res=$? | res</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   return ${res}</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function vbox_img_works {</span></div>
<div class="line"><span class="comment">   cd ${VMPATH}</span></div>
<div class="line"><span class="comment">   if test &quot;$(bin/vbox-img --version)&quot; != &quot;&quot;; then</span></div>
<div class="line"><span class="comment">       return 0</span></div>
<div class="line"><span class="comment">   else</span></div>
<div class="line"><span class="comment">       return 1</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function create_usb_system {</span></div>
<div class="line"><span class="comment">   if ! vbox_img_works -o ${BUILD_VIRTUALBOX} = &quot;true&quot;; then</span></div>
<div class="line"><span class="comment">       build_virtualbox</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   if  vbox_img_works; then</span></div>
<div class="line"><span class="comment">       echo &quot;Cloning virtual disk to USB device ${USB_DEVICE} ...&quot;</span></div>
<div class="line"><span class="comment">       clone_vm_to_usb</span></div>
<div class="line"><span class="comment">       if test $? != 0; then</span></div>
<div class="line"><span class="comment">           echo &quot;Cloning VDI disk to USB deice failed !&quot;</span></div>
<div class="line"><span class="comment">           exit -1</span></div>
<div class="line"><span class="comment">       fi</span></div>
<div class="line"><span class="comment">   else</span></div>
<div class="line"><span class="comment">       echo &quot;Cloning virtual disk to raw...&quot;</span></div>
<div class="line"><span class="comment">       clone_vm_to_raw</span></div>
<div class="line"><span class="comment">       if test $? != 0; then</span></div>
<div class="line"><span class="comment">           echo &quot;Cloning VDI disk to RAW failed !&quot;</span></div>
<div class="line"><span class="comment">           exit -1</span></div>
<div class="line"><span class="comment">       fi</span></div>
<div class="line"><span class="comment">       echo</span></div>
<div class="line"><span class="comment">       echo &quot;Copying to USB stick...&quot;</span></div>
<div class="line"><span class="comment">       echo</span></div>
<div class="line"><span class="comment">       dd_to_usb</span></div>
<div class="line"><span class="comment">       echo</span></div>
<div class="line"><span class="comment">       if test $? != 0; then</span></div>
<div class="line"><span class="comment">           echo &quot;Copying raw file to USB device failed!&quot;</span></div>
<div class="line"><span class="comment">           echo &quot;Check that your USB device has at least 50 GiB of reachable space&quot;</span></div>
<div class="line"><span class="comment">           exit -1</span></div>
<div class="line"><span class="comment">       fi</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   echo &quot;Launching Clonezilla to create compressed image...&quot;</span></div>
<div class="line"><span class="comment">   echo</span></div>
<div class="line"><span class="comment">   # Succeeds or exits</span></div>
<div class="line"><span class="comment">   clonezilla_usb_to_image</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">function cleanup  {</span></div>
<div class="line"><span class="comment">   if test &quot;${CLEANUP}&quot; != &quot;true&quot;; then</span></div>
<div class="line"><span class="comment">       return 0</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   cd ${VMPATH}</span></div>
<div class="line"><span class="comment">   rm *.xz</span></div>
<div class="line"><span class="comment">   rm *.iso</span></div>
<div class="line"><span class="comment">   rm -rf ISOFILES</span></div>
<div class="line"><span class="comment">   if test -d mnt; then</span></div>
<div class="line"><span class="comment">       sudo umount -l mnt</span></div>
<div class="line"><span class="comment">       rmdir mnt</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   if test -d mnt2; then</span></div>
<div class="line"><span class="comment">       sudo rm -rf mnt2</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">   rm -rvf ${VM}</span></div>
<div class="line"><span class="comment">   rm -vf ${VM}.vdi</span></div>
<div class="line"><span class="comment">   exit 0</span></div>
<div class="line"><span class="comment">}</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">if test &quot;$(echo ${CLI} | sed &#39;s/help_md//&#39; )&quot; != &quot;${CLI}&quot;; then</span></div>
<div class="line"><span class="comment">   help_md</span></div>
<div class="line"><span class="comment">   exit 0</span></div>
<div class="line"><span class="comment">fi</span></div>
<div class="line"><span class="comment">if test &quot;$(echo ${CLI} | sed &#39;s/help//&#39; )&quot; != &quot;${CLI}&quot;; then</span></div>
<div class="line"><span class="comment">   help</span></div>
<div class="line"><span class="comment">   exit 0</span></div>
<div class="line"><span class="comment">fi</span></div>
<div class="line"><span class="comment">echo &quot;PARAMETERS&quot;</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">for ((i=0; i&lt;ARRAY_LENGTH; i++)) ; do test_cli $i; done</span></div>
<div class="line"><span class="comment">export VERSION</span></div>
<div class="line"><span class="comment">export VERSION_FULL</span></div>
<div class="line"><span class="comment">export VMPATH</span></div>
<div class="line"><span class="comment">export LINENO_PATCH</span></div>
<div class="line"><span class="comment">export DOWNLOAD_CLONEZILLA_PATH</span></div>
<div class="line"><span class="comment">/bin/bash fetch_clonezilla_iso.sh</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">echo &quot;Fetching live CD...&quot;</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">fetch_livecd</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">echo &quot;Fetching stage3 tarball...&quot;</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">fetch_stage3</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">echo &quot;Tweaking live CD...&quot;</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">make_boot_from_livecd</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">echo &quot;Creating VM&quot;</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">create_vm</span></div>
<div class="line"><span class="comment">if test $? != 0; then</span></div>
<div class="line"><span class="comment">   echo &quot;VM failed to be created!&quot;</span></div>
<div class="line"><span class="comment">   exit -1</span></div>
<div class="line"><span class="comment">fi</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">if test ${CREATE_ISO} != &quot;true&quot;; then</span></div>
<div class="line"><span class="comment">   cleanup</span></div>
<div class="line"><span class="comment">fi</span></div>
<div class="line"><span class="comment">if test &quot;${USB_DEVICE}&quot; != &quot;&quot;; then</span></div>
<div class="line"><span class="comment">   echo</span></div>
<div class="line"><span class="comment">   echo &quot;Building VirtualBox...&quot;</span></div>
<div class="line"><span class="comment">   echo</span></div>
<div class="line"><span class="comment">   create_usb_system</span></div>
<div class="line"><span class="comment">else</span></div>
<div class="line"><span class="comment">   process_clonezilla_iso</span></div>
<div class="line"><span class="comment">   create_iso_vm</span></div>
<div class="line"><span class="comment">   echo</span></div>
<div class="line"><span class="comment">   echo &quot;Launching Clonezilla to create ISO install medium...&quot;</span></div>
<div class="line"><span class="comment">   echo</span></div>
<div class="line"><span class="comment">fi</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">echo &quot;Launching Clonezilla to create ISO install medium...&quot;</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">clonezilla_to_iso ${LIVECD} ISOFILES</span></div>
<div class="line"><span class="comment">echo</span></div>
<div class="line"><span class="comment">if test $? = 0; then</span></div>
<div class="line"><span class="comment">   echo &quot;Done.&quot;</span></div>
<div class="line"><span class="comment">   if test -f &quot;${ISO_OUTPUT}&quot;; then</span></div>
<div class="line"><span class="comment">       echo &quot;ISO install medium was created here: ${ISO_OUTPUT}&quot;</span></div>
<div class="line"><span class="comment">   else</span></div>
<div class="line"><span class="comment">       echo &quot;ISO install medium failed to be created.&quot;</span></div>
<div class="line"><span class="comment">   fi</span></div>
<div class="line"><span class="comment">else</span></div>
<div class="line"><span class="comment">   echo &quot;ISO install medium failed to be created!&quot;</span></div>
<div class="line"><span class="comment">   exit -1</span></div>
<div class="line"><span class="comment">fi</span></div>
<div class="line"><span class="comment">cleanup</span></div>
</div><!-- fragment --> </div><!-- contents -->
<div class="ttc" id="amkgentoo_8sh_html_ad1451b50408769582d8f5bd4254fe7b1"><div class="ttname"><a href="mkgentoo_8sh.html#ad1451b50408769582d8f5bd4254fe7b1">PATH</a></div><div class="ttdeci">Exported String PATH</div><div class="ttdef"><b>Definition:</b> <a href="mkgentoo_8sh_source.html#l00449">mkgentoo.sh:449</a></div></div>
<div class="ttc" id="amkgentoo_8sh_html_a214cb10953cb8efbb6a2092fdb4ff6fd"><div class="ttname"><a href="mkgentoo_8sh.html#a214cb10953cb8efbb6a2092fdb4ff6fd">ARR</a></div><div class="ttdeci">String Array ARR</div><div class="ttdef"><b>Definition:</b> <a href="mkgentoo_8sh_source.html#l00055">mkgentoo.sh:55</a></div></div>
<div class="ttc" id="abuild__virtualbox_8sh_html_a62ad76d689932a98f7cc9667b6fa903d"><div class="ttname"><a href="build__virtualbox_8sh.html#a62ad76d689932a98f7cc9667b6fa903d">VMPATH</a></div><div class="ttdeci">Exported String VMPATH</div><div class="ttdef"><b>Definition:</b> <a href="build__virtualbox_8sh_source.html#l00002">build_virtualbox.sh:2</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
