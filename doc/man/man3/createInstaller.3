.TH "createInstaller" 3 "Sun Oct 4 2020" "Version 1.0" "gentoo-creator" \" -*- nroff -*-
.ad l
.nh
.SH NAME
createInstaller
.SH SYNOPSIS
.br
.PP
.SS "Functions"

.in +1c
.ti -1c
.RI "\fBget_gentoo_install_iso\fP ()"
.br
.RI "Download minimal Gentoo install ISO file and caches\&. "
.ti -1c
.RI "\fBtest_cli_pre\fP ()"
.br
.RI "Check VirtualBox version and prepare commandline analysis\&. "
.ti -1c
.RI "\fBtest_cli\fP (cli)"
.br
.RI "Analyse commandline\&. "
.ti -1c
.RI "\fBtest_cli_post\fP ()"
.br
.RI "Check commanline coherence and incompatibilities\&. "
.ti -1c
.RI "\fBhelp_md\fP ()"
.br
.RI "Print usage in markdown format\&. "
.ti -1c
.RI "\fBhelp_\fP ()"
.br
.RI "Print usage to stdout\&. "
.ti -1c
.RI "\fBfetch_livecd\fP ()"
.br
.RI "Downloads Gentoo install CD\&. "
.ti -1c
.RI "\fBfetch_stage3\fP ()"
.br
.RI "Downloads a fresh stage3 Gentoo archive\&. "
.ti -1c
.RI "\fBmake_boot_from_livecd\fP ()"
.br
.RI "Tweak the Gentoo minimal install CD so that the custom- made shell scripts and stage3 archive are included into the squashfs filesystem\&. "
.ti -1c
.RI "\fBtest_vm_running\fP (vm)"
.br
.RI "Checks if VM as first named argument exists and is running\&. "
.ti -1c
.RI "\fBdelete_vm\fP (vm, ext)"
.br
.RI "Powers off, possibly with emergency stop, the VM names as first argument\&. "
.ti -1c
.RI "\fBcreate_vm\fP ()"
.br
.RI "Create main VirtualBox machine using VBoxManage commandline\&. "
.ti -1c
.RI "\fBclonezilla_to_iso\fP (iso, dir)"
.br
.RI "Create Gentoo linux clonezilla ISO installer out of a clonezilla directory structure and an clonezilla image\&. "
.ti -1c
.RI "\fBprocess_clonezilla_iso\fP ()"
.br
.RI "Download clonezilla ISO or recover it from cache calling #fetch_clonezilla_iso\&. 
.br
Upgrade it with virtualbox guest additions\&. "
.ti -1c
.RI "\fBbuild_virtualbox\fP ()"
.br
.RI "Build VirtualBox from source using an unsquashed clonezilla CD as a chrooted environment\&. "
.ti -1c
.RI "\fBcreate_iso_vm\fP ()"
.br
.RI "Create the new VirtualBox machine aimed at converting the VDI virtualdisk containing the Gentoo Linux distribution into an XZ-compressed clonezilla image uneder \fBISOFILES/home/partimag/image\fP\&. "
.ti -1c
.RI "\fBclone_vm_to_device\fP ()"
.br
.RI "Directly clone Gentoo VM to USB stick (or any using block device) "
.ti -1c
.RI "\fBclone_vm_to_raw\fP ()"
.br
.RI "Use\&. "
.ti -1c
.RI "\fBdd_to_usb\fP ()"
.br
.RI "Bare-metal copy of temporary RAW disk to external device\&. "
.ti -1c
.RI "\fBclonezilla_device_to_image\fP ()"
.br
.RI "Create CloneZilla xz-compressed image out of an external block device (like a USB stick) "
.ti -1c
.RI "\fBvbox_img_works\fP ()"
.br
.RI "Test if \fBvbox-img\fP is functional\&. "
.ti -1c
.RI "\fBcreate_usb_system\fP ()"
.br
.RI "Clone VDI virtual disk to external device (like a USB stick) "
.ti -1c
.RI "\fBcleanup\fP ()"
.br
.RI "Clean up all temporary files and directpries (except for VirtualBox build) "
.ti -1c
.RI "\fBgenerate_Gentoo\fP ()"
.br
.RI "Launch routines: fetch install IO, starge3 archive, create VM\&. "
.ti -1c
.RI "\fBmain\fP ()"
.br
.RI "Main function launching routines\&. "
.in -1c
.SS "Variables"

.in +1c
.ti -1c
.RI "ReadOnly String \fBCLI\fP = '$*'"
.br
.RI "Command line\&. "
.ti -1c
.RI "ReadOnly String Array \fBARR\fP"
.br
.RI "global string array of switches and default values "
.ti -1c
.RI "ReadOnly Integer \fBARRAY_LENGTH\fP = $((${#\fBARR\fP[*]}/3))"
.br
.RI "Number of switches (true length of array divided by 3) "
.ti -1c
.RI "Exported String \fBISO\fP = 'downloaded\&.iso'"
.br
.RI "Name of downloaded clonezilla ISO file\&. "
.in -1c
.SH "Detailed Description"
.PP 

.SH "Function Documentation"
.PP 
.SS "build_virtualbox ()"

.PP
Build VirtualBox from source using an unsquashed clonezilla CD as a chrooted environment\&. Build scripts are copied from \fBclonezilla/build\fP 
.PP
\fBNote\fP
.RS 4
This stage is only necessay if \fBvbox-img\fP is to be used to directly convert the VDI virtual disk into a block device, on account of a bug in Oracle source code (ticket #19901)\&. 
.br
This is only needed to reduce disk space requirements and avoid a temporary RAW file on disk of about 50 GB\&. Otherwise it is simpler to use the distribution stock version\&. 
.RE
.PP

.PP
Definition at line 843 of file mkgentoo\&.sh\&.
.SS "cleanup ()"

.PP
Clean up all temporary files and directpries (except for VirtualBox build) 
.PP
Definition at line 1078 of file mkgentoo\&.sh\&.
.SS "clone_vm_to_device ()"

.PP
Directly clone Gentoo VM to USB stick (or any using block device) 
.PP
\fBWarning\fP
.RS 4
Requests the \fIpatched\fP version of \fBvbox-img\fP on account of Oracle source code bug (ticket #19901) 
.RE
.PP
\fBNote\fP
.RS 4
Either build it beforehand or specify on commandline: 
.PP
.nf
build_virtualbox=true 

.fi
.PP
 
.RE
.PP

.PP
Definition at line 904 of file mkgentoo\&.sh\&.
.SS "clone_vm_to_raw ()"

.PP
Use\&. 
.PP
.nf
VBoxManage clonemedium 

.fi
.PP
 to clone VDI to RAW file before bare-metal copy to device\&. 
.PP
Definition at line 927 of file mkgentoo\&.sh\&.
.SS "clonezilla_device_to_image ()"

.PP
Create CloneZilla xz-compressed image out of an external block device (like a USB stick) Image is created under ISOFILES/home/partimag/image under VMPATH 
.PP
\fBReturn values\fP
.RS 4
\fI0\fP on success otherwise exits -1 on failure 
.RE
.PP

.PP
Definition at line 962 of file mkgentoo\&.sh\&.
.SS "clonezilla_to_iso (iso, dir)"

.PP
Create Gentoo linux clonezilla ISO installer out of a clonezilla directory structure and an clonezilla image\&. 
.PP
\fBParameters\fP
.RS 4
\fIiso\fP ISO output 
.br
\fIdir\fP Directory to be transformed into ISO output 
.RE
.PP
\fBNote\fP
.RS 4
ISO can be burned to DVD or used to create a bootable USB stick using dd on *nix platforms or Rufus (on Windows)\&. 
.RE
.PP

.PP
Definition at line 765 of file mkgentoo\&.sh\&.
.SS "create_iso_vm ()"

.PP
Create the new VirtualBox machine aimed at converting the VDI virtualdisk containing the Gentoo Linux distribution into an XZ-compressed clonezilla image uneder \fBISOFILES/home/partimag/image\fP\&. Register machine, create VDI drive, create IDE drive attach disks to controlers 
.br
Attach newly augmented clonezilla LiveCD to IDE controller\&. 
.br
Wait for the VM to complete its task\&. Check that it is still running every minute\&. 
.br
\fBNote\fP
.RS 4
VM may be visible (vmtype=gui) or silent (vmtype=headless, currently to be fixed)\&. Wait for the VM to complete task\&. 
.br
A new VM is necessary as the first VM used to build the Gentoo filesystem does not contain clonezilla or the VirtualBox guest additions (requested for sharing folders with host)\&. Calls \fBprocess_clonezilla_iso\fP to satisfy these requirements\&. 
.RE
.PP
\fBWarning\fP
.RS 4
the \fBsharedfolder\fP command may fail vith older version of VirtualBox or not be implemented\&. It is transient, so it disappears on shutdown and requests prior startup of VM to be activated\&. 
.RE
.PP

.PP
Definition at line 868 of file mkgentoo\&.sh\&.
.SS "create_usb_system ()"

.PP
Clone VDI virtual disk to external device (like a USB stick) Two options are available\&. If vbox-img (patched) is functional after building VirtualBox from source, then use it and clone VDI directly to external device\&. Otherwise create a temporary RAW file and bare-metal copy this file to external device\&. 
.PP
\fBReturn values\fP
.RS 4
\fIIn\fP the first case, the exit code of \fBclone_vm_to_device\fP 
.br
\fIIn\fP the second case, the exit code of \fBdd_to_usb\fP following \fBclone_vm_to_raw\fP 
.RE
.PP

.PP
Definition at line 1052 of file mkgentoo\&.sh\&.
.SS "create_vm ()"

.PP
Create main VirtualBox machine using VBoxManage commandline\&. Register machine, create VDI drive, create IDE drive attach disks to controlers 
.br
Attach augmented clonezilla LiveCD to IDE controller\&. 
.br
Wait for the VM to complete its task\&. Check that it is still running every minute\&. 
.br
Finally compact it\&. 
.PP
\fBNote\fP
.RS 4
VM may be visible (vmtype=gui) or without GUI (vmtype=headless, currently to be fixed) 
.RE
.PP
\fBTodo\fP
.RS 4
Find a way to only compact on success and never on failure of VM\&. 
.RE
.PP

.PP
Definition at line 656 of file mkgentoo\&.sh\&.
.SS "dd_to_usb ()"

.PP
Bare-metal copy of temporary RAW disk to external device\&. 
.PP
\fBNote\fP
.RS 4
Used only if vbox-img (patched version) has not been built\&. 
.RE
.PP

.PP
Definition at line 936 of file mkgentoo\&.sh\&.
.SS "delete_vm (vm, ext)"

.PP
Powers off, possibly with emergency stop, the VM names as first argument\&. 
.PP
\fBParameters\fP
.RS 4
\fIvm\fP VM name 
.br
\fIext\fP virtual disk extension, without dot (defaults to 'vdi')\&.
.RE
.PP
.PD 0
.IP "\(bu" 2
Unregisters it 
.IP "\(bu" 2
Deletes its folder structure and hard drive (default is 'vdi' as a second argument) 
.PP
\fBReturn values\fP
.RS 4
\fIReturns\fP 0 if Directory and hard drive could be erased, otherwise the OR value of both erasing commands 
.RE
.PP

.PP

.PP
Definition at line 597 of file mkgentoo\&.sh\&.
.SS "fetch_livecd ()"

.PP
Downloads Gentoo install CD\&. Caches it as ${ISO} 
.PP
\fBReturn values\fP
.RS 4
\fIReturns\fP 0 on success or -1 on exit 
.RE
.PP

.PP
Definition at line 323 of file mkgentoo\&.sh\&.
.SS "fetch_stage3 ()"

.PP
Downloads a fresh stage3 Gentoo archive\&. Caches it as ${STAGE3} 
.PP
\fBReturn values\fP
.RS 4
\fIReturns\fP 0 on success or -1 on exit 
.RE
.PP

.PP
Definition at line 366 of file mkgentoo\&.sh\&.
.SS "generate_Gentoo ()"

.PP
Launch routines: fetch install IO, starge3 archive, create VM\&. 
.PP
Definition at line 1095 of file mkgentoo\&.sh\&.
.SS "get_gentoo_install_iso ()"

.PP
Download minimal Gentoo install ISO file and caches\&. Optionaly checks MD5SUMS\&. 
.PP
Definition at line 8 of file fetch_clonezilla_iso\&.sh\&.
.SS "help_ ()"

.PP
Print usage to stdout\&. 
.PP
Definition at line 313 of file mkgentoo\&.sh\&.
.SS "help_md ()"

.PP
Print usage in markdown format\&. 
.PP
Definition at line 280 of file mkgentoo\&.sh\&.
.SS "main ()"

.PP
Main function launching routines\&. 
.PP
\fBTodo\fP
.RS 4
Daemonize the part below generate_Gentoo when #VMPTYPE is \fCheadless\fP so that the script can be detached completely with \fCnohup mkgentoo \&.\&.\&. &\fP 
.RE
.PP

.PP
Definition at line 1123 of file mkgentoo\&.sh\&.
.SS "make_boot_from_livecd ()"

.PP
Tweak the Gentoo minimal install CD so that the custom- made shell scripts and stage3 archive are included into the squashfs filesystem\&. This function is returned from early if
.PP
.nf
create_squashfs=false 

.fi
.PP
 is given on commandline\&. 
.PP
\fBNote\fP
.RS 4
Will be run in the ${VM} virtual machine 
.RE
.PP
\fBReturn values\fP
.RS 4
\fIReturns\fP 0 on success or -1 on failure\&. 
.RE
.PP

.PP
Definition at line 417 of file mkgentoo\&.sh\&.
.SS "process_clonezilla_iso ()"

.PP
Download clonezilla ISO or recover it from cache calling #fetch_clonezilla_iso\&. 
.br
Upgrade it with virtualbox guest additions\&. Chroot into the clonezilla Ubuntu GNU/Linux distribution and runs apt to build kernel modules and install the VirtualBox guest additions ISO image\&. 
.br
Upgrade clonezilla kernel consequently Recreates the quashfs system after exiting chroot\&. Copy the new \fBisolinux\&.cfg\fP parameter file: automates and silences clonezilla behaviour on disk recovery\&. Calls \fBclonezilla_to_iso\fP 
.PP
\fBNote\fP
.RS 4
Installing the guest additions is a prerequisite to folder sharing between the ISO VM and the host\&. Folder sharing is necessary to recover a compressed clonezilla image of the VDI virtual disk into the ISOFILES/home/partimag/image directory\&. 
.RE
.PP

.PP
Definition at line 796 of file mkgentoo\&.sh\&.
.SS "test_cli (cli)"

.PP
Analyse commandline\&. 
.PP
\fBParameters\fP
.RS 4
\fIcli\fP Commandline
.RE
.PP
Create globals of the form VAR=arg when there is var=arg on commandline 
.br
Otherwise assign default values VAR=defaults (3rd argument in array ARR) 
.PP
Definition at line 218 of file mkgentoo\&.sh\&.
.SS "test_cli_post ()"

.PP
Check commanline coherence and incompatibilities\&. 
.PP
\fBReturn values\fP
.RS 4
\fI0\fP or exit -1 on incompatibilities 
.RE
.PP

.PP
Definition at line 245 of file mkgentoo\&.sh\&.
.SS "test_cli_pre ()"

.PP
Check VirtualBox version and prepare commandline analysis\&. 
.PP
\fBReturn values\fP
.RS 4
\fI0\fP otherwise exit -1 if VirtualBox is too old 
.RE
.PP

.PP
Definition at line 154 of file mkgentoo\&.sh\&.
.SS "test_vm_running (vm)"

.PP
Checks if VM as first named argument exists and is running\&. 
.PP
\fBParameters\fP
.RS 4
\fIvm\fP VM name or UUID 
.RE
.PP
\fBReturn values\fP
.RS 4
\fIReturns\fP 0 on success and 1 is VM is not listed or not running 
.RE
.PP

.PP
Definition at line 554 of file mkgentoo\&.sh\&.
.SS "vbox_img_works ()"

.PP
Test if \fBvbox-img\fP is functional\&. \fBvbox-img\fP is a script; it refers to \fBvbox-img\&.bin\fP, which is a soft link to the VirtuaBox patched build\&. 
.PP
\fBReturn values\fP
.RS 4
\fI0\fP if vbox-img --version is non-empty 
.br
\fI1\fP otherwise 
.RE
.PP

.PP
Definition at line 1026 of file mkgentoo\&.sh\&.
.SH "Variable Documentation"
.PP 
.SS "ARR"

.PP
global string array of switches and default values Structure is as follows:
.PP
.nf
("commandline switch" "Description"  "Default value" \&.\&.\&.) 

.fi
.PP
 A double-entry arry will be simulated using indexes\&.
.PP
\fBNote\fP
.RS 4
\fCdebug_mode\fP should be place up front in the array 
.RE
.PP

.PP
Definition at line 79 of file mkgentoo\&.sh\&.
.SS "ARRAY_LENGTH = $((${#\fBARR\fP[*]}/3))"

.PP
Number of switches (true length of array divided by 3) 
.PP
Definition at line 141 of file mkgentoo\&.sh\&.
.SS "CLI = '$*'"

.PP
Command line\&. 
.PP
Definition at line 69 of file mkgentoo\&.sh\&.
.SS "ISO = 'downloaded\&.iso'"

.PP
Name of downloaded clonezilla ISO file\&. 
.PP
Definition at line 147 of file mkgentoo\&.sh\&.
.SH "Author"
.PP 
Generated automatically by Doxygen for gentoo-creator from the source code\&.
